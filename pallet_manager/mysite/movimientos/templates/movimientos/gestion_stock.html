{% extends 'base.html' %}
{% load static %}

{% block head %}
  <!-- (opcional) tu css existente -->
  <link rel="stylesheet" href="{% static 'gestion_stock/gestion_stock.css' %}">
  <!-- Bootstrap Bundle JS (incluye Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const POST_URL = "{% url 'movimientos:actualizar_stock' %}";
  </script> 
  <script src="{% static 'gestion_stock/gestion_stock.js' %}"></script>
{% endblock %}

{% block content %}

<div class="page-wrap">

  <!-- Sidebar LOCAL con íconos -->
  {% include 'includes/sidebar.html' %}

  <!-- Contenido -->
  <main class="content">
    <h4 class="mb-3">Gestión de stock</h4>

    <div class="btn-operation-container">
      <button id="btn-operation" class="btn-morph btn me-2 btn-operation">
        <i class="bi bi-plus"></i>
        Nueva operación
      </button>
    </div>
    <!-- Donuts (solo número dentro) -->
    <div class="row-compact">

      <div class="counter-card">
        <svg class="donut" viewBox="0 0 36 36" overflow="visible">
          <circle class="bg" cx="18" cy="18" r="15.915"></circle>
          <circle class="ring" cx="18" cy="18" r="15.915" stroke="#00D3B7"></circle>
          <text x="18" y="18">
            {{ contadores.disponibles|default:0 }}
          </text>
        </svg>
        <p class="counter-title">Disponibles</p>
      </div>

      <div class="counter-card alt-1">
        <svg class="donut" viewBox="0 0 36 36" overflow="visible">
          <circle class="bg" cx="18" cy="18" r="15.915"></circle>
          <circle class="ring" cx="18" cy="18" r="15.915" stroke="#FFCC66"></circle>
          <text x="18" y="18">
            {{ contadores.en_uso|default:0 }}
          </text>
        </svg>
        <p class="counter-title">En uso</p>
      </div>

      <div class="counter-card alt-2">
        <svg class="donut" viewBox="0 0 36 36" overflow="visible">
          <circle class="bg" cx="18" cy="18" r="15.915"></circle>
          <circle class="ring" cx="18" cy="18" r="15.915" stroke="#FF6B6B"></circle>
          <text x="18" y="18">
            {{ contadores.danados|default:0 }}
          </text>
        </svg>
        <p class="counter-title">Dañados</p>
      </div>

    </div>

    <!-- Tabla -->
    <section class="my-2">
      <div class="table-wrap">
        <table id="tabla-stock" class="table-morph">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Cantidad total</th>
              <th>Disponibles</th>
              <th>En uso</th>
              <th>Dañados</th>
            </tr>
          </thead>
          <tbody id="tbody-stock">
            {% for s in stock_data %}
            <tr>
              <td>{{ s.tipo }}</td>
              <td>{{ s.total }}</td>
              <td>{{ s.disponibles }}</td>
              <td>{{ s.en_uso }}</td>
              <td>{{ s.danados }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5">Sin datos de stock.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Form -->
    <form class="form-stock" data-post-url="{% url 'movimientos:actualizar_stock' %}">
      <div class="form-header-container">
        <h4>Nueva Operación</h4>
        <button class="form-btn-cancel"><i class="bi bi-x-circle-fill"></i></button>
      </div>
      <div class="mb-2">
        <label class="form-label mb-1">Ingreso/Egreso</label>
        <select id="fld-operacion" class="form-select">
          <option value="IN">Ingreso</option>
          <option value="OUT">Egreso</option>
        </select>
      </div>
      <div class="mb-2">
        <label class="form-label mb-1">Tipo</label>
        <select id="fld-tipo" class="form-select">
          {% for t in tipos %}
            <option value="{{ t.id }}" data-name="{{ t.label }}">{{ t.label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label mb-1">Cantidad</label>
        <input id="fld-cantidad" type="number" min="1" class="form-control" placeholder="0" inputmode="numeric">
      </div>
      <button id="btn-agregar" class="btn-morph w-100">Confirmar</button>
    </form>

    <!-- Volver -->
    <div class="footer-actions">
      <a href="/movimientos/" class="btn-morph btn btn-volver">Volver</a>
    </div>
  </main>
</div>

<!-- Modal confirmación -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar operación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body"><p id="confirm-text" class="mb-0"></p></div>
      <div class="modal-footer">
        <button id="btn-confirmar" class="btn btn-primary">Confirmar</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div id="toast-body" class="toast-body">Mensaje</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
    </div>
  </div>
</div>
{% endblock %}
